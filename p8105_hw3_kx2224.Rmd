---
title: "Hw3"
author: "Kangyu Xu (kx2224)"
date: "2024-10-17"
output: github_document
---
```{r}
library(p8105.datasets)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)
library(tidyverse)
```


## Question1

```{r}
data("ny_noaa")
str(ny_noaa)
dim(ny_noaa)
```
### Dataset Description
The dataset contains `r dim(ny_noaa)[1]` rows and `r dim(ny_noaa)[2]` columns. The key variables include:

1. id: Identifier for the weather station.
2. date: The date of observation.
3. tmax: Maximum daily temperature (in tenths of degrees Celsius).
4. tmin: Minimum daily temperature (in tenths of degrees Celsius).
5. prcp: Precipitation in tenths of millimeters.
6. snow: Snowfall in millimeters.
7. snwd: Snow depth in millimeters.

### Data Cleaning 

```{r}
ny_noaa_cleaned = ny_noaa |>
  janitor::clean_names() |>
  mutate(tmax = as.numeric(tmax) / 10, 
         tmin = as.numeric(tmin) / 10,
         prcp = prcp / 10,
         year = year(date),
         month = month(date),
         day = day(date)) |> 
  select(year, month, day, everything(), -date) |>
  filter(tmax > tmin | is.na(tmax) | is.na(tmin)) |>
  filter(snow >= 0 | is.na(snow)) |>
  filter(!(is.na(snow) & is.na(snwd) & is.na(tmax) & is.na(tmin) & is.na(prcp))) |>
  rename(
    tmax_c = tmax,     
    tmin_c = tmin,     
    prcp_mm = prcp,   
    snow_mm = snow,    
    snwd_mm = snwd     
  )
```

```{r}
snow_common = ny_noaa_cleaned |>
  count(snow_mm) |>
  arrange(desc(n))

snow_common
```
For snowfall, the most commonly observed values is 0. It is because almost days in New York will not snow.

### Plot
```{r}
jan_jul_tmax = ny_noaa_cleaned |>
  filter(month %in% c(1, 7)) |>
  group_by(id, year, month) |>
  summarize(avg_tmax = mean(tmax_c, na.rm = TRUE))

ggplot(jan_jul_tmax, aes(x = year, y = avg_tmax, color = as.factor(month))) +
  geom_boxplot() +
  facet_wrap(~ month) +
  labs(title = "Average Max Temperature in January and July",
       x = "Year", y = "Max Temperature (°C)", color = "Month") +
  theme_minimal()
```
There appears to be some variability in the average maximum temperatures across stations and years, particularly in July. Some stations show outliers, with unusually high or low temperatures for certain.

### Plot -2
```{r}
tmax_tmin_plot = ggplot(ny_noaa_cleaned, aes(x = tmin_c, y = tmax_c)) +
  geom_point(alpha = 0.3) +
  labs(title = "Tmax vs Tmin",
       x = "Min Temperature (°C)", y = "Max Temperature (°C)") +
  theme_minimal()

tmax_tmin_plot


```

```{r}
snowfall_violin = ny_noaa_cleaned |>
  filter(snow_mm > 0 & snow_mm < 100) |>
  ggplot(aes(x = factor(year), y = snow_mm)) +
  geom_violin() +
  labs(title = "Distribution of Snowfall by Year (0 < Snowfall < 100 mm)",
       x = "Year", y = "Snowfall (mm)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

snowfall_violin

```
## Problem 2

### Load data
```{r}
demographic_data = read_csv("data/nhanes_covar.csv", na = c("NA", ".", ""), skip = 4) |>
  janitor::clean_names() 

accelerometer_data = read_csv("data/nhanes_accel.csv", na = c("NA", ".", "")) |>
  janitor::clean_names() 
```
### merge data
```{r}
merged_data = left_join(demographic_data, accelerometer_data, by = "seqn")
```

### clean data
```{r}
cleaned_data = merged_data |> 
  pivot_longer(cols = starts_with("min"),
               names_to = "minute",
               values_to = "acc") |>
  filter(age >= 21) |>
  drop_na(sex, age, bmi, education) |>
  mutate(
    sex = recode(sex, "1" = "Male", "2" = "Female"),
    education = recode(education, "1" = "Less than High School", "2" = "High School Equivalent", "3" = "More than High School"),
    sex = as_factor(sex), 
    education = fct_relevel(education, "Less than High School", "High School Equivalent", "More than High School"))
head(cleaned_data)
```

### reader-friendly tabel
```{r}
fri_data = cleaned_data |>
  group_by(sex, education) |>
  count()
head(fri_data)
```


### plot 
```{r}
### Age distribution using violin plot
ggplot(cleaned_data, aes(x = education, y = age, fill = sex)) +
  geom_violin(trim = FALSE, scale = "width") +
  geom_boxplot(width = 0.1, position = position_dodge(0.9), color = "black", alpha = 0.2) +
  labs(title = "Age Distribution by Sex and Education (Violin Plot)",
       x = "Education Level",
       y = "Age",
       fill = "Sex") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
The violin plot shows that both men and women are primarily middle-aged (40–60 years) across all education levels. In the "Less than High School" group, women tend to be older, while men have a more even age distribution. For "High School Equivalent," men are concentrated around ages 40–50, with women spanning a broader range. In "More than High School," both sexes cluster around 40–60, with women skewing slightly older. Overall, women generally appear older across the categories, particularly at lower education levels, but the distributions are relatively similar.

```{r}
### Aggregate total activity for each participant
total_activity_data = cleaned_data |>
  group_by(seqn, sex, age, education) |>
  summarize(total_activity = sum(acc, na.rm = TRUE))

### Plot total activity against age, comparing men to women, with separate panels for education
ggplot(total_activity_data, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) +  # Scatter plot for total activity
  geom_smooth(method = "loess", se = FALSE) +  # Add a smooth trend line
  facet_wrap(~education) +  # Separate panels by education level
  labs(title = "Total Activity vs. Age by Sex and Education Level",
       x = "Age",
       y = "Total Activity",
       color = "Sex") +
  theme_minimal()
```

1. Less than High School: Women are more active than men at younger ages, but men have slightly higher activity levels after 60.

2. High School Equivalent: Women show more variation in activity, with a peak around age 40, while men’s activity is more stable but lower.

3. More than High School: Women maintain higher activity than men, especially between ages 50–60, though both sexes show a decline after 60.

```{r}
time_course_data = cleaned_data |>
  group_by(minute, sex, education) |>
  summarize(mean_activity = mean(acc, na.rm = TRUE))

### 24-hour activity time course plot
ggplot(time_course_data, aes(x = as.numeric(gsub("min", "", minute)), y = mean_activity, color = sex)) +
  geom_line(size = 1, alpha = 0.7) +
  geom_smooth(se = FALSE, method = "loess", linetype = "dashed") +  # Smooth trend lines
  facet_wrap(~education) +
  labs(title = "24-Hour Activity Time Course by Education Level and Sex",
       x = "Time (Minutes from Start of Day)",
       y = "Mean Activity Level",
       color = "Sex") +
  theme_minimal()
```

1. General Trends: Activity levels fluctuate throughout the day, with noticeable peaks and troughs indicating periods of increased and decreased movement.

2. Sex Differences: Across all education levels, women may show slightly higher overall activity, especially during the middle of the day.

3. Education Levels: The "More than High School" group might show more consistent activity throughout the day, while those with "Less than High School" may display more pronounced peaks and dips, suggesting less sustained activity.


## Problem 3

```{r}
data_Jan_20 = 
  read_csv("data/Jan 2020 Citi.csv") |>
  mutate(date = as.Date("2020-01-01"))
data_Jan_24 = 
  read_csv("data/Jan 2024 Citi.csv") |>
  mutate(date = as.Date("2024-01-01"))
data_July_20 = 
  read_csv("data/July 2020 Citi.csv") |>
  mutate(date = as.Date("2020-07-01"))
data_July_24 = 
  read_csv("data/July 2024 Citi.csv") |>
  mutate(date = as.Date("2024-07-01"))
```
### Clean data

```{r}
total_data = 
  bind_rows(data_Jan_20,data_Jan_24,data_July_20,data_July_24)|>
  distinct()|>
  janitor::clean_names()|>
  pivot_longer(start_station_name: end_station_name, names_to = "station_status", values_to = "station_name", names_pattern = "(start|end)_station_name")

head(total_data)
```
### Data information summary
```{r}
bike_type = total_data|> pull(rideable_type)|> unique()
most_weekdays = total_data|> count(weekdays)|> arrange(desc(n))
avg_duration = total_data|> pull(duration)|> mean(na.rm = TRUE)
num_member = total_data|> count(member_casual)
bike_type
most_weekdays
avg_duration
num_member
```

- So the combine data set contains `r nrow(total_data)/2` order information. This dataset concludes the information of each ride's duration, date, start station, end station, ride type and the ride weekdays.
- The bike types contains `r bike_type`. The most busy weekdays to ride bike is `r most_weekdays[1, 1]`, and the number of orders is `r most_weekdays[1, 2]`. The average duration of ride is `r avg_duration`. The percentage of members is `r num_member[2, 2]/nrow(total_data)`.

### Make table of total number of rides in each combination.
```{r}
total_rides_table = total_data |>
  mutate(year = format(date, "%Y"), 
         month = format(date, "%B")) |>
  group_by(year, month, member_casual) |>
  summarize(total_rides = n(), .groups = 'drop') |>
  pivot_wider(names_from = member_casual, values_from = total_rides, values_fill = 0) |>
  mutate(total_rides = member + casual,
         member_proportion = member / total_rides) |>
  arrange(year, match(month, month.name))

# Display the table in a reader-friendly format
library(knitr)
kable(total_rides_table, caption = "Total Number of Rides and Member Rider Proportion by Year, Month, and Rider Type", digits = 2)

```
- Therefore, the number of riders will increase on summer both 2020 and 2024. Also the proportion of member riders will decreases on summer. From 2020 to 2024, the number of both kinds of riders increases a lot. 

### make a table of 5 most popular starting stations
```{r}
top_stations_July_24 = total_data |>
  filter(format(date, "%Y-%m") == "2024-07", station_status == "start") |>
  count(station_name, sort = TRUE) |>
  top_n(5, n)

# Display the top 5 stations table
kable(top_stations_July_24, caption = "Top 5 Most Popular Starting Stations for July 2024", col.names = c("Station Name", "Number of Rides"))
```
- The 5 most popular starting stations for July 2024 are: Pier 61 at Chelsea Piers: 163 rides; University Pl & E 14 St: 155 rides; W 21 St & 6 Ave: 152 rides; West St & Chambers St: 150 rides; W 31 St & 7 Ave: 146 rides.

### Plot of the effect of day of the week
```{r}
### Prepare data for plotting median ride duration by day of the week, month, and year
ride_duration_data = total_data |>
  mutate(year = format(date, "%Y"),
         month = format(date, "%B"),
         weekdays = fct_relevel(weekdays, "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) |>
  group_by(year, month, weekdays) |>
  summarize(median_duration = median(duration, na.rm = TRUE))
ride_duration_data
```

```{r}
ride_duration_plot = ggplot(ride_duration_data, aes(x = weekdays, y = median_duration, fill = year)) +
  geom_bar(stat = 'identity', position = position_dodge()) +  # Bar plot with dodge position for months
  facet_grid(. ~ month) +  # Separate panels for each year
  labs(title = 'Effects of Day of the Week, Month, and Year on Median Ride Duration',
       x = 'Day of the Week',
       y = 'Median Ride Duration (minutes)',
       fill = 'Year') +
  theme_minimal() +  # Use a minimal theme for clean aesthetics
  theme(axis.text.x = element_text(angle = 90, hjust = 1))  # Rotate X-axis labels for better readability

# Display the plot
ride_duration_plot

```

- In 2020, the median ride duration appears to be consistently higher compared to 2024, particularly for the month of July. This could indicate a trend where people in 2020 took longer rides, possibly due to different social factors, infrastructure, or external conditions.

- The weekend days (Saturday and Sunday) in both January and July tend to show higher median ride durations compared to weekdays. This suggests that people may be using the service for leisure activities on weekends, resulting in longer rides. During weekdays, the median ride durations are more uniform and shorter, especially in January for both years, which might reflect more commuter-based usage during the workweek.

### Make a figure
```{r}
data_2024 = total_data |>
  mutate(
    month = format(date, "%B"),
    year = format(date, "%Y")
  )|>
  filter(year == "2024")
head(data_2024)
```
```{r}
ride_duration_plot_2024 = 
  ggplot(
    data_2024, 
    aes(x = month, y = duration, fill = member_casual)
    ) + 
  geom_violin(alpha = 0.7, scale = "width") +  
  facet_grid(rideable_type ~ member_casual) +  
  labs(
    title = "Impact of Month, Membership Status, and Bike Type on Ride Duration (2024)",
    x = "Month", 
    y = "Ride Duration (Minutes)", 
    fill = "Membership Status"
    ) +
  theme_minimal() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

ride_duration_plot_2024
```

1. Casual Riders vs. Members:

  - Casual riders (shown in pink) tend to have much longer ride durations compared to members (shown in blue), especially for classic bikes. This suggests that casual riders might use bikes more for leisure or sightseeing, resulting in longer trips.
Members, on the other hand, have consistently shorter and more uniform ride durations, indicating more utilitarian or commuting use, especially for electric bikes.

2. Bike Type Impact:

  - Electric bikes show generally shorter ride durations compared to classic bikes for both casual riders and members. This is likely because electric bikes are used for quicker, more efficient trips, particularly by members.

  - Casual riders on classic bikes exhibit a much wider distribution in ride duration, with some very long rides, especially in July.

3. Seasonal Differences (January vs. July):

  - Ride durations are longer in July compared to January for casual riders, likely due to better weather conditions encouraging more leisurely and extended rides.

  - For members, there is less seasonal variation in ride durations, suggesting that their riding patterns are more consistent throughout the year, likely due to commuting.




















